<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Home</title>
  <style>
    :root{
      --bg:#0b0f17;
      --card:#111827;
      --border:#1f2937;
      --muted:rgba(230,237,243,.65);
      --text:#e6edf3;
      --link:#7dd3fc;
      --chip:#0b1220;
      --chipBorder:#334155;
      --shadow: 0 10px 24px rgba(0,0,0,.28);
      --radius:16px;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; margin:0; background:var(--bg); color:var(--text)}
    .wrap{max-width:1280px; margin:0 auto; padding:18px}
    .topbar{display:flex; gap:12px; align-items:center; margin-bottom:14px; flex-wrap:wrap}
    .brand{font-weight:700; letter-spacing:.2px}
    .muted{opacity:.7; font-size:12px}
    .grid{display:grid; grid-template-columns: 1.15fr 1.7fr 1.15fr; gap:14px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow: var(--shadow)}
    h2{margin:0 0 10px; font-size:16px}
    h3{margin:12px 0 8px; font-size:13px; color:var(--muted)}
    a{color:var(--link); text-decoration:none}
    a:hover{text-decoration:underline}
    ul{margin:0; padding-left:18px}
    input{width:100%; box-sizing:border-box; border-radius:14px; padding:12px 12px; border:1px solid var(--chipBorder); background:var(--chip); color:var(--text)}
    .btns{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap}
    button{border-radius:14px; padding:10px 12px; border:1px solid var(--chipBorder); background:var(--chip); color:var(--text); cursor:pointer}
    button:hover{background:#0f1a30}
    .row{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .badge{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; border:1px solid var(--chipBorder); background:rgba(11,18,32,.7); font-size:12px; color:var(--muted)}
    .dot{width:8px; height:8px; border-radius:999px; background:#ef4444; box-shadow:0 0 0 4px rgba(239,68,68,.18)}
    .list{display:flex; flex-direction:column; gap:10px}
    .item{display:flex; gap:10px; padding:10px; border:1px solid var(--border); border-radius:14px; background:rgba(17,24,39,.55)}
    .thumb{width:96px; height:54px; border-radius:10px; border:1px solid var(--border); object-fit:cover; flex:0 0 auto}
    .meta{min-width:0}
    .title{font-size:13px; line-height:1.25; margin:0 0 6px; font-weight:600; word-break:break-word}
    .sub{font-size:12px; color:var(--muted); display:flex; gap:10px; flex-wrap:wrap}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; border:1px solid var(--chipBorder); background:rgba(11,18,32,.7)}
    .rightcol ul{padding-left:16px}
    .small{font-size:12px; color:var(--muted)}
    .bookmarkBar{display:flex; gap:10px; margin-top:10px}
    .bookmarkBar input{flex:1 1 auto; min-width:160px}
    .bookmarkGrid{display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:10px; margin-top:10px}
    .bmItem{position:relative; border:1px solid var(--border); border-radius:14px; background:rgba(17,24,39,.55); padding:10px; cursor:pointer}
    .bmItem:hover{background:rgba(17,24,39,.75)}
    .bmRow{display:flex; gap:10px; align-items:center}
    .bmIcon{width:18px; height:18px; border-radius:4px; border:1px solid var(--border); background:rgba(11,18,32,.7); object-fit:cover; flex:0 0 auto}
    .bmName{font-size:13px; font-weight:650; line-height:1.2; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .bmUrl{margin-top:6px; font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .bmActions{position:absolute; top:8px; right:8px; display:flex; gap:8px}
    .bmActions button{padding:6px 8px; border-radius:12px; font-size:12px}
    @media (max-width: 1040px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">ğŸ  Ryan's Dashboard</div>
      <div class="badge" id="statusBadge">â³ æ­£åœ¨åŠ è½½æ•°æ®â€¦</div>
      <div class="muted" id="updatedAt"></div>
    </div>

    <div class="grid">
      <!-- å·¦åˆ— -->
      <div class="card">
        <h2>ğŸ” æœç´¢</h2>
        <input id="q" placeholder="è¾“å…¥å…³é”®è¯ï¼Œå›è½¦æœç´¢â€¦" />
        <div class="btns">
          <button onclick="go('google')">Google</button>
          <button onclick="go('bili')">Bç«™</button>
          <button onclick="go('yt')">YouTube</button>
        </div>

        <h3>â­ ä¹¦ç­¾</h3>
        <div class="bookmarkBar">
          <input id="bmUrl" placeholder="ç²˜è´´ç½‘å€ï¼Œä¾‹å¦‚ https://github.com/" />
          <button id="bmAddBtn">æ·»åŠ </button>
        </div>
        <div class="bookmarkGrid" id="bookmarkGrid"></div>
        <p class="small">ä¼šè‡ªåŠ¨æŠ“å–ç½‘ç«™æ ‡é¢˜ä¸å›¾æ ‡ï¼›æŠ“ä¸åˆ°æ—¶å¯ç‚¹ âœï¸ æ”¹åã€‚</p>
      </div>

      <!-- ä¸­åˆ—ï¼šå¼€æ’­ç›‘æ§ -->
      <div class="card" id="liveCard">
        <h2>ğŸ“º å¼€æ’­ç›‘æ§</h2>
        <div class="muted">æ­£åœ¨åŠ è½½â€¦</div>
      </div>

      <!-- å³åˆ—ï¼šé¢„ç•™æ¨¡å— -->
      <div class="card rightcol">
        <h2>ğŸ§© æ¨¡å—</h2>
        <ul>
          <li>ğŸ“° çƒ­æ¦œï¼ˆBç«™/å¾®åš/HNï¼‰</li>
          <li>âœ… å¾…åŠï¼ˆæœ¬åœ°å­˜å‚¨/äº‘ç«¯åŒæ­¥ï¼‰</li>
          <li>ğŸŒ¦ï¸ å¤©æ°”ï¼ˆå¯é€‰ï¼‰</li>
          <li>ğŸ’» Homelab çŠ¶æ€ï¼ˆæ¢æ´»/é¢æ¿ï¼‰</li>
        </ul>
        <p class="small">ä½ æƒ³ä¸‹ä¸€æ­¥å…ˆåŠ å“ªä¸ªï¼Ÿæˆ‘æŒ‰ä½ ä¹ æƒ¯å¾€â€œä¿¡æ¯å¯†é›†â€æ–¹å‘å †èµ·æ¥ã€‚</p>
      </div>
    </div>
  </div>

<script>
function go(engine){
  const q = document.getElementById('q').value.trim();
  if(!q) return;
  const m = {
    google: `https://www.google.com/search?q=${encodeURIComponent(q)}`,
    bili: `https://search.bilibili.com/all?keyword=${encodeURIComponent(q)}`,
    yt: `https://www.youtube.com/results?search_query=${encodeURIComponent(q)}`
  };
  window.open(m[engine], '_blank');
}
document.getElementById('q').addEventListener('keydown', (e)=>{
  if(e.key === 'Enter') go('google');
});

const BOOKMARK_KEY = "bookmarks_v1";

function escapeHtml(s){
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");
}

function normalizeUrl(input){
  const raw = String(input || "").trim();
  if(!raw) return null;
  const withProto = /^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//.test(raw) ? raw : `https://${raw}`;
  try{
    const u = new URL(withProto);
    if(u.protocol !== "http:" && u.protocol !== "https:") return null;
    return u.toString();
  }catch{
    return null;
  }
}

function faviconFallback(urlStr){
  try{
    const u = new URL(urlStr);
    return `https://www.google.com/s2/favicons?domain=${encodeURIComponent(u.hostname)}&sz=64`;
  }catch{
    return "";
  }
}

function loadBookmarks(){
  try{
    const raw = localStorage.getItem(BOOKMARK_KEY);
    if(!raw) return null;
    const list = JSON.parse(raw);
    return Array.isArray(list) ? list : null;
  }catch{
    return null;
  }
}

function saveBookmarks(list){
  localStorage.setItem(BOOKMARK_KEY, JSON.stringify(list));
}

function ensureDefaultBookmarks(){
  const existing = loadBookmarks();
  if(existing && existing.length) return existing;
  const now = Date.now();
  const defaults = [
    { id: crypto.randomUUID(), url: "https://www.youtube.com/", name: "YouTube", icon: faviconFallback("https://www.youtube.com/"), createdAt: now },
    { id: crypto.randomUUID(), url: "https://www.bilibili.com/", name: "å“”å“©å“”å“©", icon: faviconFallback("https://www.bilibili.com/"), createdAt: now + 1 },
    { id: crypto.randomUUID(), url: "https://github.com/", name: "GitHub", icon: faviconFallback("https://github.com/"), createdAt: now + 2 },
  ];
  saveBookmarks(defaults);
  return defaults;
}

async function fetchMeta(urlStr){
  try{
    const r = await fetch(`/api/meta?u=${encodeURIComponent(urlStr)}`, { cache: "no-store" });
    if(!r.ok) return null;
    return await r.json();
  }catch{
    return null;
  }
}

function renderBookmarks(){
  const grid = document.getElementById("bookmarkGrid");
  const list = loadBookmarks() || [];
  if(!list.length){
    grid.innerHTML = `<div class="muted">æš‚æ— ä¹¦ç­¾</div>`;
    return;
  }
  grid.innerHTML = list
    .slice()
    .sort((a,b)=>(a.createdAt||0)-(b.createdAt||0))
    .map((x)=>{
      const name = escapeHtml(x.name || "æœªå‘½å");
      const url = x.url || "#";
      const urlText = escapeHtml(url);
      const icon = x.icon ? escapeHtml(x.icon) : "";
      return `
        <div class="bmItem" data-id="${escapeHtml(x.id)}" role="button" tabindex="0">
          <div class="bmActions">
            <button data-act="edit" title="æ”¹å">âœï¸</button>
            <button data-act="del" title="åˆ é™¤">ğŸ—‘ï¸</button>
          </div>
          <div class="bmRow">
            ${icon ? `<img class="bmIcon" src="${icon}" alt="">` : `<div class="bmIcon"></div>`}
            <div class="bmName" title="${name}">${name}</div>
          </div>
          <div class="bmUrl" title="${urlText}">${urlText}</div>
        </div>
      `;
    }).join("");
}

async function addBookmark(){
  const input = document.getElementById("bmUrl");
  const btn = document.getElementById("bmAddBtn");
  const normalized = normalizeUrl(input.value);
  if(!normalized){
    input.focus();
    return;
  }

  const list = loadBookmarks() || [];
  if(list.some(x => x.url === normalized)){
    input.value = "";
    return;
  }

  btn.disabled = true;
  const oldText = btn.textContent;
  btn.textContent = "æ·»åŠ ä¸­â€¦";

  const meta = await fetchMeta(normalized);

  let name = null;
  let icon = null;
  try{
    const u = new URL(normalized);
    name = meta?.title || u.hostname;
    icon = meta?.icon || faviconFallback(normalized);
  }catch{
    name = meta?.title || "æœªå‘½å";
    icon = meta?.icon || "";
  }

  list.push({
    id: crypto.randomUUID(),
    url: normalized,
    name,
    icon,
    createdAt: Date.now(),
  });
  saveBookmarks(list);
  renderBookmarks();

  input.value = "";
  btn.textContent = oldText;
  btn.disabled = false;
}

function updateBookmarkName(id, name){
  const list = loadBookmarks() || [];
  const idx = list.findIndex(x => x.id === id);
  if(idx < 0) return;
  list[idx] = { ...list[idx], name };
  saveBookmarks(list);
  renderBookmarks();
}

function deleteBookmark(id){
  const list = loadBookmarks() || [];
  const next = list.filter(x => x.id !== id);
  saveBookmarks(next);
  renderBookmarks();
}

function bindBookmarkUI(){
  const input = document.getElementById("bmUrl");
  const btn = document.getElementById("bmAddBtn");
  btn.addEventListener("click", addBookmark);
  input.addEventListener("keydown", (e)=>{
    if(e.key === "Enter") addBookmark();
  });

  const grid = document.getElementById("bookmarkGrid");
  grid.addEventListener("click", (e)=>{
    const t = e.target;
    const card = t.closest?.(".bmItem");
    if(!card) return;
    const id = card.getAttribute("data-id");
    const act = t.getAttribute?.("data-act");
    if(act === "edit"){
      e.preventDefault();
      e.stopPropagation();
      const list = loadBookmarks() || [];
      const cur = list.find(x => x.id === id);
      const nextName = prompt("è¾“å…¥ä¹¦ç­¾åç§°ï¼š", cur?.name || "");
      if(nextName === null) return;
      const trimmed = nextName.trim();
      if(!trimmed) return;
      updateBookmarkName(id, trimmed);
      return;
    }
    if(act === "del"){
      e.preventDefault();
      e.stopPropagation();
      deleteBookmark(id);
      return;
    }

    const list = loadBookmarks() || [];
    const cur = list.find(x => x.id === id);
    if(cur?.url) window.open(cur.url, "_blank");
  });

  grid.addEventListener("keydown", (e)=>{
    const card = e.target.closest?.(".bmItem");
    if(!card) return;
    if(e.key !== "Enter") return;
    const id = card.getAttribute("data-id");
    const list = loadBookmarks() || [];
    const cur = list.find(x => x.id === id);
    if(cur?.url) window.open(cur.url, "_blank");
  });
}

function fmtTime(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleString();
  }catch{ return iso; }
}

function renderItems(items, fallbackText){
  if(!items || items.length === 0) return `<div class="muted">${fallbackText}</div>`;
  return `<div class="list">${
    items.map(x => {
      const rawThumb = x.thumb || x.cover || "";
      const thumb = rawThumb ? `/api/img?u=${encodeURIComponent(rawThumb)}` : "";
      const title = x.title || "ï¼ˆæ— æ ‡é¢˜ï¼‰";
      const url = x.url || "#";
      const line1 = x.platform === "bilibili"
        ? `${x.uname || "Bç«™ä¸»æ’­"}`
        : `${x.channelTitle || "YouTube"}`;
      const tag = x.platform === "bilibili"
        ? (x.live_status === 1 ? "LIVE" : "OFF")
        : (x.eventType === "live" ? "LIVE" : "UPCOMING");

      const tagDot = (tag === "LIVE") ? `<span class="dot"></span>` : "";

      return `
        <div class="item">
          ${thumb ? `<img class="thumb" src="${thumb}" alt="">` : `<div class="thumb"></div>`}
          <div class="meta">
            <div class="row">
              <div class="pill">${tagDot}<span>${tag}</span></div>
              <div class="small">${x.publishedAt ? fmtTime(x.publishedAt) : ""}</div>
            </div>
            <div class="title"><a href="${url}" target="_blank">${title}</a></div>
            <div class="sub">
              <span>${line1}</span>
              <span class="pill">${x.platform}</span>
            </div>
          </div>
        </div>
      `;
    }).join("")
  }</div>`;
}

async function refreshLive(){
  const badge = document.getElementById("statusBadge");
  const updatedAt = document.getElementById("updatedAt");
  const box = document.getElementById("liveCard");

  try{
    badge.textContent = "â³ æ‹‰å–ä¸­â€¦";
    const r = await fetch(`/api/live?ts=${Date.now()}`, { cache: "no-store" });
    const data = await r.json();

    updatedAt.textContent = `æ›´æ–°ï¼š${fmtTime(data.updated_at)} Â· ${data.version || ""}`;
    badge.textContent = "âœ… åœ¨çº¿";

    const liveBili = (data.bili || []).filter(x => x.live_status === 1);
    const liveYT   = (data.youtube || []).filter(x => x.eventType === "live");
    const upYT     = (data.youtube || []).filter(x => x.eventType === "upcoming");
    const chatYT   = (data.youtube_chatroom || []);

    box.innerHTML = `
      <h2>ğŸ“º å¼€æ’­ç›‘æ§</h2>

      <h3>ğŸ”´ æ­£åœ¨ç›´æ’­ï¼ˆBç«™ï¼‰</h3>
      ${renderItems(liveBili, "æš‚æ— ")}

      <h3>ğŸ”´ æ­£åœ¨ç›´æ’­ï¼ˆYouTubeï¼‰</h3>
      ${renderItems(liveYT, "æš‚æ— ")}

      <h3>â³ ç›´æ’­é¢„å‘Šï¼ˆYouTubeï¼‰</h3>
      ${renderItems(upYT, "æš‚æ— ")}

      <h3>ğŸ’¬ å¸¸é©»èŠå¤©å®¤ï¼ˆYouTubeï¼‰</h3>
      ${renderItems(chatYT, "æš‚æ— ")}
    `;
  }catch(e){
    badge.textContent = "âŒ å¼‚å¸¸";
    box.innerHTML = `
      <h2>ğŸ“º å¼€æ’­ç›‘æ§</h2>
      <div class="muted">åŠ è½½å¤±è´¥ï¼š${String(e)}</div>
      <div class="muted">ä½ å¯ä»¥æ‰“å¼€ <a href="/api/live?ts=${Date.now()}" target="_blank">/api/live</a> çœ‹è¯¦ç»†æŠ¥é”™ã€‚</div>
    `;
  }
}

refreshLive();
setInterval(refreshLive, 60_000);

ensureDefaultBookmarks();
renderBookmarks();
bindBookmarkUI();
</script>
</body>
</html>
